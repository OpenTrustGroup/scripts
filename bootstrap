#!/bin/bash
# Copyright 2018 Open Trust Group
# Copyright 2017 The Fuchsia Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

set -e

function usage {
  cat <<END
usage: bootstrap [gzos|trusty] [dev|stable]

Bootstrap a TEE development environment. Default: gzos
END
}

if [[ $# -gt 2 ]]; then
  usage
  exit 1
fi

tee=${1:-gzos}
version=${2:-stable}

declare manifest_name=""
declare manifest_file=""
declare manifest_url=""
declare manifest_branch=""

if [[ "${tee}" == "gzos" ]]; then
  if [[ "${version}" == "dev" ]]; then
    manifest_name="garnet"
    manifest_file="manifest/garnet"
    manifest_url="https://review.gerrithub.io/OpenTrustGroup/garnet"
    manifest_branch="gzos_dev"
  else
    manifest_name="manifest"
    manifest_file="gzos_stable"
    manifest_url="https://review.gerrithub.io/OpenTrustGroup/manifest"
    manifest_branch="gzos"
  fi
elif [[ "${tee}" == "trusty" ]]; then
  manifest_name="manifest"
  manifest_file="trusty"
  manifest_url="https://review.gerrithub.io/OpenTrustGroup/manifest"
  manifest_branch="gzos"
else
  usage
  exit 1
fi

# The fetched script will
# - create "fuchsia" directory if it does not exist,
# - download "jiri" command to "fuchsia/.jiri_root/bin"
curl -s "https://fuchsia.googlesource.com/jiri/+/master/scripts/bootstrap_jiri?format=TEXT" | base64 --decode | bash -s "${tee}_${version}"
cd "${tee}_${version}"

.jiri_root/bin/jiri import -name="${manifest_name}" -remote-branch="${manifest_branch}" "${manifest_file}" "${manifest_url}"

.jiri_root/bin/jiri update -hook-timeout=120

mkdir -p ~/bin
cp .jiri_root/bin/jiri ~/bin
rm -f ~/bin/fx
ln -sf `pwd`/scripts/fx ~/bin

echo "# generated by bootstrap" > .config
echo "TEE=${tee}" >> .config

echo "Done creating ${tee} development environment at \"$(pwd)\"."
echo "Recommended: export PATH=\"$HOME/bin:\$PATH\""
