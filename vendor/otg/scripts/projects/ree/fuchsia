#!/bin/bash
# Copyright 2018 Open Trust Group
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

set -eo pipefail

# Setup environment variable for `fx set`
FUCHSIA_OUT_DIR="${OTG_REE_OUT_DIR}"
FUCHSIA_CONFIG="${OTG_REE_OUT_DIR}/.config"

REE_OUT="$(basename "${OTG_REE_OUT_DIR}")"
FUCHSIA_BUILD_DIR="${FUCHSIA_OUT_DIR}/arm64"

if [[ "$1" == "-c" ]]; then
  printf "Deleting ${FUCHSIA_OUT_DIR}\n"
  rm -rf ${FUCHSIA_OUT_DIR}
fi

mkdir -p ${FUCHSIA_OUT_DIR}

fx set arm64 ${FUCHSIA_BUILD_DIR} \
--packages garnet/packages/gzos_ree \
--netboot \
--args disable_zedboot=true \
--args zircon_tools_dir=\"//${REE_OUT}/build-zircon/tools\" \
--args zircon_build_abi_dir=\"//${REE_OUT}/build-zircon/build-arm64\" \
--zircon-arg "-o ${FUCHSIA_OUT_DIR}" \
--zircon-arg SUB_PROJECT=gzos_ree \

fx build-zircon USE_CLANG=true
fx build

source "${FUCHSIA_BUILD_DIR}"/image_paths.sh

entropy=$(head -c 32 /dev/urandom | shasum -a 256 | awk '{ print $1 }')

kernel_img="${FUCHSIA_BUILD_DIR}/${IMAGE_QEMU_KERNEL_RAW}"
initrd_img="${FUCHSIA_BUILD_DIR}/${IMAGE_NETBOOT_ZBI}"
kernel_cmdline="TERM=screen-256color kernel.entropy-mixin=${entropy} kernel.halt-on-panic=true"

otg-save-ree-boot-param "${kernel_img}" "${initrd_img}" "${kernel_cmdline}"
