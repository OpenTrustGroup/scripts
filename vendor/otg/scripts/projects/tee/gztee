#!/bin/bash
# Copyright 2018 Open Trust Group
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

set -eo pipefail

# Setup environment variable for `fx set`
FUCHSIA_OUT_DIR="${OTG_TEE_OUT_DIR}"
FUCHSIA_CONFIG="${OTG_TEE_OUT_DIR}/.config"

TEE_OUT="$(basename "${OTG_TEE_OUT_DIR}")"
FUCHSIA_BUILD_DIR="${FUCHSIA_OUT_DIR}/arm64"
ZIRCON_BUILD_DIR="${FUCHSIA_OUT_DIR}/build-zircon/build-arm64"

if [[ "$1" == "-c" ]]; then
  printf "Deleting ${FUCHSIA_OUT_DIR}\n"
  rm -rf ${FUCHSIA_OUT_DIR}
fi

mkdir -p ${FUCHSIA_OUT_DIR}

fx set arm64 ${FUCHSIA_BUILD_DIR} \
--packages garnet/packages/gzos \
--packages build/packages/user_bootfs \
--args disable_zedboot=true \
--args kernel_cmdline_files=[\"//${TEE_OUT}/kernel_cmdline\"] \
--args zircon_tools_dir=\"//${TEE_OUT}/build-zircon/tools\" \
--args zircon_build_abi_dir=\"//${TEE_OUT}/build-zircon/build-arm64\" \
--boards garnet/boards/arm64_dummy.gni \
--zircon-arg "-o ${FUCHSIA_OUT_DIR}" \
--zircon-arg SUB_PROJECT=gzos

declare KERNEL_CMDLINE_FILE="${FUCHSIA_OUT_DIR}/kernel_cmdline"

echo "Generating ${KERNEL_CMDLINE_FILE}..."
cat >"${KERNEL_CMDLINE_FILE}" <<END
TERM=screen-256color
kernel.entropy-mixin=$(head -c 32 /dev/urandom | shasum -a 256 | awk '{ print $1 }')
kernel.halt-on-panic=true
kernel.shell=false
kernel.oom.enable=false
kernel.oom.redline-mb=1
ktrace.bufsize=1
virtcon.disable=true
netsvc.disable=true
gzsvcs.enable=true
END

fx build-zircon
fx build

atf_spd="trusty"
bl32_img="${ZIRCON_BUILD_DIR}/qemu-tz-zircon.bin"
bl32_extra1_img="${FUCHSIA_BUILD_DIR}/user.bootfs"

otg-save-tee-boot-param "${atf_spd}" "${bl32_img}" "${bl32_extra1_img}"
